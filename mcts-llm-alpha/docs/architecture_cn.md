# MCTS-LLM Alpha挖掘架构

## 概述

MCTS-LLM Alpha挖掘框架结合了蒙特卡洛树搜索与大语言模型，用于发现量化交易的新型alpha因子。本文档描述了系统架构和关键设计决策。

**最新更新 (2025-01-22)**: 系统已完成14项修复，确保与原始论文算法完全一致。主要改进包括Virtual Action机制、0-10评分范围统一、符号参数生成和Few-shot学习。

## 系统架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   CLI/API       │────▶│   MCTS引擎      │────▶│   LLM客户端     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
         │                       │                         │
         ▼                       ▼                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│     配置管理     │     │   公式处理器    │     │    提示模板      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
         │                       │                         
         ▼                       ▼                         
┌─────────────────┐     ┌─────────────────┐     
│   数据提供者     │     │     评估器      │     
└─────────────────┘     └─────────────────┘     
```

## 组件描述

### 1. MCTS引擎 (`mcts/`)

探索alpha公式空间的核心搜索算法：

- **MCTSNode**：表示搜索树中的节点，跟踪公式及其分数（0-10范围）
  - UCT计算包含归一化机制
  - 支持每个维度最多扩展2次
- **MCTSSearch**：实现MCTS的四个阶段（选择、扩展、模拟、反向传播）
  - Virtual Action机制允许内部节点继续扩展
  - 动态预算调整基于历史最高分
  - 维度选择使用e_max=10的softmax策略
- **FrequentSubtreeMiner**：识别过度使用的模式以保持多样性
  - 只挖掘root genes（从字段开始的子树）
  - 参数值抽象化为符号't'

### 2. LLM集成 (`llm/`)

与语言模型的接口，用于公式生成：

- **LLMClient**：带有重试逻辑的OpenAI API封装
  - 符号参数生成机制（w1, w2, t等）
  - 参数候选值评估和选择
- **Prompts**：不同生成上下文的模板管理
  - 集成节点上下文信息
  - Few-shot示例支持
- **ExampleSelector**：维度特定的示例选择策略
  - Effectiveness/Stability: 相关性过滤
  - Diversity: 最低相关性选择
  - Turnover/Overfitting: Zero-shot
- 两步生成过程：画像 → 符号公式 → 参数实例化

### 3. 公式处理 (`formula/`)

处理公式操作和验证：

- **Cleaner**：移除LaTeX、markdown和其他痕迹
- **Fixer**：转换操作符并添加缺失参数
- **Validator**：语法和操作符验证

### 4. 评估系统 (`evaluation/`)

多维度公式评估：

- **ComprehensiveEvaluator**：协调整体评估流程
  - 仅使用Qlib进行真实评估（移除了模拟模式）
- **RelativeRankingEvaluator**：相对排名机制
  - 维护有效alpha仓库（effectiveness >= 3.0）
  - 动态提升评估标准
  - 所有分数统一到0-10范围
- **维度评估器**：各维度的具体实现
  - Effectiveness: 信号强度
  - Stability: 稳定性
  - Turnover: 换手率
  - Diversity: 多样性
  - Overfitting: 过拟合风险（默认5.0）

### 5. 数据层 (`data/`)

为灵活性抽象数据访问：

- **DataProvider**：市场数据访问接口
- **QlibDataProvider**：基于Qlib的实现
- **MarketDataManager**：高级数据管理

### 6. 配置管理 (`config/`)

集中式配置管理：

- 基于YAML的配置文件
- 用于验证的Pydantic模型
- 环境变量支持
- **scoring_config.py**：统一的评分系统配置
  - 0-10评分范围定义
  - UCT归一化参数
  - 各维度阈值（effectiveness: 3.0, diversity: 2.0, overall: 5.0）

## 关键设计模式

### 1. 依赖注入

MCTS引擎接受公式生成/评估函数作为参数，将算法与实现解耦：

```python
mcts = MCTSSearch(
    formula_generator=generator_func,
    formula_refiner=refiner_func,
    formula_evaluator=evaluator_func
)
```

### 2. 策略模式

多个数据提供者实现相同接口，允许在Qlib和其他数据源之间轻松切换。

### 3. 模板方法

两步公式生成（画像 → 公式）遵循带有可定制提示的模板模式。

### 4. 仓库模式

alpha仓库管理已发现的公式，具有自动大小控制和多样性维护。

## 数据流

1. **初始化**：加载配置 → 初始化数据提供者 → 设置LLM客户端
2. **搜索循环**：
   - 使用UCT选择节点
   - 通过LLM生成优化公式
   - 在市场数据上评估公式
   - 更新树统计信息
3. **输出**：保存最佳公式和搜索检查点

## 多维度评估

公式在五个维度上进行评估（0-10分制）：

1. **有效性**：预测能力和信号强度（阈值: 3.0）
2. **稳定性**：跨市场条件的一致性
3. **换手率**：交易频率影响（越低越好）
4. **多样性**：与现有因子相比的独特性（阈值: 2.0）
5. **过拟合**：泛化能力（默认: 5.0）

整体阈值: 5.0

## 扩展点

架构支持多种扩展机制：

1. **自定义操作符**：在`formula/fixer.py`中添加新操作符
2. **替代LLM**：在`llm/`中实现新客户端
3. **数据源**：创建实现`DataProvider`的新提供者
4. **评估指标**：扩展`evaluation/metrics/`
5. **搜索策略**：修改MCTS参数或选择策略

## 性能考虑

- **缓存**：公式评估被缓存以避免冗余计算
- **检查点**：定期保存使长时间搜索能够恢复
- **批处理**：LLM调用可以批量处理以提高效率
- **内存管理**：仓库大小限制防止无限增长

## 安全考虑

- API密钥从环境变量加载
- 没有硬编码的凭据
- 公式验证防止代码注入
- 沙盒化的评估环境

## 部署架构

### 本地开发
```
├── .env                 # 环境变量
├── config/             # 配置文件
├── logs/              # 日志文件
├── checkpoints/       # 搜索检查点
└── results/           # Alpha发现
```

### 生产部署
- Docker容器化
- GPU支持Qlib加速
- 可能的分布式评估
- 结果持久化到数据库

## 监控与可观察性

- 全程结构化日志
- 指标收集：
  - 公式生成成功率
  - 评估性能
  - 缓存命中率
  - 搜索树统计
- 检查点分析工具

## 未来增强

1. **分布式搜索**：并行多个MCTS树
2. **在线学习**：适应市场体制变化
3. **多市场支持**：超越CSI300
4. **实时评估**：流数据集成
5. **AutoML集成**：超参数优化